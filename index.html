<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¤éŸ»å°æ±ºï¼šV22 çš‡å®¶ç¾å­¸ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+TC:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* ğŸ‘‘ çš‡å®¶é…è‰²ç³»çµ± */
            --bg-dark: #0f1219;
            --bg-gradient: radial-gradient(circle at 50% 0%, #2c3e50 0%, #0f1219 80%);
            
            --gold-primary: #d4af37;
            --gold-shine: #f7efd2;
            --gold-metal: linear-gradient(135deg, #bf953f 0%, #fcf6ba 40%, #b38728 60%, #aa771c 100%);
            
            --red-royal: #8a1c1c;
            --red-metal: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%);
            
            --panel-bg: rgba(20, 25, 35, 0.7);
            --panel-border: 1px solid rgba(212, 175, 55, 0.3);
            --shadow-glow: 0 0 20px rgba(212, 175, 55, 0.2);
            
            --font-title: 'Ma Shan Zheng', cursive;
            --font-body: 'Noto Serif TC', serif;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            background: var(--bg-dark);
            background-image: var(--bg-gradient);
            font-family: var(--font-body); color: #fff;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* èƒŒæ™¯ç´‹ç†ï¼šé›²ç´‹ */
        body::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 40a40 40 0 0 1 40-40h40v40a40 40 0 0 1-40 40H0V40zm40 0a40 40 0 0 1 40-40v40H40z' fill='%23d4af37' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.6; z-index: 0; pointer-events: none;
        }

        #app {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; z-index: 1;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- Header: æ‡¸æµ®å®®æ®¿é ‚ --- */
        header {
            height: 70px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 40px; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0));
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .app-title { 
            font-family: var(--font-title); font-size: 2.8rem; letter-spacing: 5px;
            background: var(--gold-metal); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 10px rgba(212, 175, 55, 0.5));
        }
        .info-pill {
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2);
            padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; color: #aaa;
        }

        /* --- Main Stage: iPad Grid Layout --- */
        #game-stage {
            flex: 1; 
            display: grid; 
            grid-template-columns: 280px 1fr 280px; /* å·¦å³å®šå¯¬ï¼Œä¸­é–“è‡ªé©æ‡‰ */
            gap: 20px; padding: 20px 40px;
            align-items: center; justify-items: center;
            height: 100%; overflow: hidden;
        }

        /* --- Team Panels: æ‡¸æµ®ç¢‘çŸ³é¢¨æ ¼ --- */
        .team-panel {
            width: 100%; height: 90%; 
            background: var(--panel-bg);
            border: var(--panel-border);
            border-radius: 100px 100px 20px 20px; /* æ‹±é–€å½¢ç‹€ */
            display: flex; flex-direction: column; align-items: center; padding: 30px 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            transition: 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }
        .team-panel.active {
            border-color: var(--gold-primary);
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.15), inset 0 0 20px rgba(212, 175, 55, 0.1);
            transform: translateY(-10px);
        }
        /* æ¿€æ´»æ™‚çš„å…‰æšˆé‚Šæ¡† */
        .team-panel.active::after {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: 100px 100px 20px 20px;
            background: linear-gradient(180deg, var(--gold-primary), transparent);
            z-index: -1; opacity: 0.5;
        }

        .avatar-frame {
            width: 100px; height: 100px; border-radius: 50%;
            background: var(--gold-metal); padding: 4px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }
        .avatar { width: 100%; height: 100%; border-radius: 50%; background-size: cover; border: 3px solid #1a1a1a; filter: sepia(0.2); }
        
        .team-title { font-family: var(--font-title); font-size: 2.2rem; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .score-display {
            font-size: 4rem; font-weight: 900; 
            background: linear-gradient(to bottom, #fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 0 rgba(0,0,0,0.5));
            line-height: 1; margin: 10px 0;
        }
        .hearts-container { font-size: 1.5rem; color: #e74c3c; margin-bottom: auto; filter: drop-shadow(0 0 5px rgba(231, 76, 60, 0.6)); }

        .student-plate {
            width: 100%; text-align: center; padding: 15px 0;
            border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto;
        }
        .student-name { font-size: 1.8rem; font-weight: bold; color: var(--gold-primary); text-shadow: 0 0 10px rgba(0,0,0,0.8); }

        /* --- Center Card: è–æ—¨å·è»¸é¢¨æ ¼ --- */
        .card-stage {
            width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; perspective: 1500px;
        }
        .main-card {
            width: 100%; max-width: 600px; height: 90%; 
            position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .main-card.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 20px; 
            /* é‚Šæ¡†æ”¹ç‚ºé›™å±¤é‡‘é‚Š */
            border: 4px solid #444; outline: 2px solid var(--gold-primary); outline-offset: -10px;
            background: #fdfbf7; 
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 30px 80px rgba(0,0,0,0.8);
        }
        /* æ­£é¢ï¼šå®£ç´™ + ç´‹ç† */
        .front { background-image: url('https://www.transparenttextures.com/patterns/rice-paper-2.png'); }
        /* èƒŒé¢ï¼šç­”æ¡ˆ */
        .back { transform: rotateY(180deg); background: #fff; padding: 40px; text-align: left; overflow-y: auto; color: #222; }

        .q-visual { height: 40%; background: #111; position: relative; border-bottom: 4px double var(--gold-primary); }
        .q-img { width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0.9; }
        
        .q-body { flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .q-text { 
            font-size: 2.5rem; font-weight: bold; color: #1a1a1a; line-height: 1.5; 
            font-family: var(--font-body);
        }
        .q-cat { 
            position: absolute; top: 15px; left: 15px; 
            background: var(--gold-primary); color: #000; padding: 4px 12px; 
            font-weight: bold; font-size: 0.9rem; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* --- Footer & Buttons: ç‰ç’ƒè³ªæ„Ÿ --- */
        footer {
            height: 100px; padding: 0 40px; 
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
            z-index: 10;
        }
        
        /* å¯¶çŸ³æŒ‰éˆ• */
        .gem-btn {
            position: relative; border: none; outline: none; background: transparent; cursor: pointer;
            padding: 16px 40px; border-radius: 50px;
            font-size: 1.3rem; font-weight: 900; color: #fff;
            background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(0,0,0,0.2));
            box-shadow: 
                0 4px 6px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.4),
                inset 0 -4px 0 rgba(0,0,0,0.2);
            transition: all 0.2s; overflow: hidden;
            display: flex; align-items: center; gap: 10px;
        }
        /* é‡‘è‰²æŒ‰éˆ• */
        .btn-gold { 
            background-color: #d4af37; 
            background-image: linear-gradient(160deg, #f1c40f, #b8860b);
            border: 2px solid #fff5c3;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
        }
        /* ç¶ è‰²æŒ‰éˆ• */
        .btn-green {
            background-image: linear-gradient(160deg, #2ecc71, #27ae60);
            border: 2px solid #a8e6cf;
        }
        /* ç´…è‰²æŒ‰éˆ• */
        .btn-red {
            background-image: linear-gradient(160deg, #e74c3c, #c0392b);
            border: 2px solid #ffbcb5;
        }
        .gem-btn:active { transform: translateY(2px); box-shadow: none; }
        
        /* æµå…‰ç‰¹æ•ˆ */
        .gem-btn::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg); animation: shine 3s infinite;
        }
        @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

        .hidden { display: none !important; }

        /* --- Overlays --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 8, 0.95); z-index: 2000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(20px);
        }

        /* --- ç²¾ç¾å¡ç‰Œè¨­è¨ˆ (Tarot Style) --- */
        .cards-container {
            display: flex; gap: 40px; perspective: 1200px;
            width: 100%; justify-content: center; align-items: center;
        }

        .tarot-card {
            width: 260px; height: 460px; /* é»ƒé‡‘æ¯”ä¾‹ */
            position: relative; cursor: pointer;
            transform-style: preserve-3d; 
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .tarot-card:hover { transform: translateY(-30px) rotateX(10deg); z-index: 10; }
        .tarot-card.flipped { transform: rotateY(180deg); }
        .tarot-card.disabled { opacity: 0.1; filter: grayscale(100%); pointer-events: none; }

        .tarot-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 15px; overflow: hidden;
            box-shadow: 0 15px 40px rgba(0,0,0,1);
        }

        /* å¡èƒŒï¼šé«˜ç´šç´‹ç† */
        .tarot-back {
            background-color: #111;
            /* å¹¾ä½•åœ–æ¡ˆ */
            background-image: 
                linear-gradient(30deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000),
                linear-gradient(150deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000),
                linear-gradient(30deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000),
                linear-gradient(150deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000),
                linear-gradient(60deg, rgba(212, 175, 55, 0.1) 25%, transparent 25.5%, transparent 75%, rgba(212, 175, 55, 0.1) 75%, rgba(212, 175, 55, 0.1)),
                linear-gradient(60deg, rgba(212, 175, 55, 0.1) 25%, transparent 25.5%, transparent 75%, rgba(212, 175, 55, 0.1) 75%, rgba(212, 175, 55, 0.1));
            background-size: 40px 70px;
            background-position: 0 0, 0 0, 20px 35px, 20px 35px, 0 0, 20px 35px;
            border: 4px solid var(--gold-primary);
            display: flex; justify-content: center; align-items: center;
        }
        
        /* ä¸­é–“çš„å¾½ç«  */
        .tarot-emblem {
            width: 120px; height: 120px; border: 2px solid var(--gold-primary);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            background: #000; box-shadow: 0 0 20px var(--gold-primary);
            font-size: 3rem;
        }

        .style-chance .tarot-back { border-color: var(--gold-primary); }
        .style-chance .tarot-emblem { color: var(--gold-primary); text-shadow: 0 0 10px var(--gold-primary); }
        
        .style-punish .tarot-back { border-color: var(--red-royal); background-image: none; background: #2b0505; }
        .style-punish .tarot-emblem { border-color: var(--red-royal); color: var(--red-royal); box-shadow: 0 0 20px var(--red-royal); }

        /* å¡é¢ï¼šå…§å®¹ */
        .tarot-front {
            background: #fffbf0; transform: rotateY(180deg);
            padding: 20px; text-align: center;
            display: flex; flex-direction: column; align-items: center;
            border: 8px solid var(--gold-primary);
        }
        .tf-type { font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase; color: #888; margin-bottom: 10px; }
        .tf-title { 
            font-family: var(--font-title); font-size: 2.5rem; line-height: 1.2; 
            color: #000; margin-bottom: 15px; border-bottom: 2px solid #ccc; padding-bottom: 10px; width: 100%;
        }
        .tf-desc { font-size: 1.2rem; color: #444; font-weight: bold; flex: 1; display: flex; align-items: center; line-height: 1.5; }
        .tf-val { 
            background: #eee; padding: 5px 20px; border-radius: 20px; font-weight: bold; color: #333; margin-top: auto;
        }

        /* --- Settings & Roster --- */
        .settings-modal {
            background: #1a1a1a; width: 600px; padding: 40px; border-radius: 20px;
            border: 1px solid #444; color: #fff; text-align: left;
            box-shadow: 0 20px 60px #000;
        }
        textarea { width: 100%; height: 150px; background: #000; border: 1px solid #444; color: #fff; padding: 10px; margin-bottom: 20px; }

        /* --- Mobile / Vertical Fallback --- */
        @media (max-width: 900px) {
            #game-stage { display: flex; flex-direction: column; overflow-y: auto; height: auto; }
            .team-panel { width: 100%; height: auto; border-radius: 20px; flex-direction: row; justify-content: space-between; padding: 15px; }
            .main-card { height: 400px; }
            .cards-container { flex-direction: column; width: 100%; }
            .tarot-card { width: 80%; height: 200px; }
            .tarot-face { flex-direction: row; padding: 20px; text-align: left; }
            footer { grid-template-columns: 1fr; height: auto; gap: 15px; padding: 20px; }
            .gem-btn { width: 100%; justify-content: center; }
            .avatar-frame { width: 60px; height: 60px; margin: 0 15px 0 0; }
        }

    </style>
</head>
<body>

<div id="app">
    <header>
        <div class="info-pill">é¡Œåº«æ•¸: <span id="q-count">0</span></div>
        <div class="app-title">å¤éŸ»å°æ±º</div>
        <button class="gem-btn" style="padding:10px 15px; font-size:1.2rem;" onclick="openSettings()">âš™ï¸</button>
    </header>

    <div id="game-stage">
        <!-- Left Panel -->
        <div class="team-panel team-a active" id="panel-a">
            <div class="avatar-frame">
                <div class="avatar" style="background-image: url('https://images.unsplash.com/photo-1542596768-5d1d21f1cfb6?w=400')"></div>
            </div>
            <div class="team-title" style="color:#ff7675;">è±ªæ”¾æ´¾</div>
            <div class="score-display" id="score-a">100</div>
            <div class="hearts-container" id="hearts-a">â¤ï¸â¤ï¸â¤ï¸</div>
            <div class="student-plate">
                <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">å…ˆé‹’æˆ°å°‡</div>
                <div class="student-name" id="student-name-a">æº–å‚™</div>
            </div>
            <!-- Admin Controls -->
            <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:5px; width:100%; opacity:0.3; transition:0.3s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.3">
                <button onclick="modStat('a','s',10)" style="background:#444; border:none; color:#fff; cursor:pointer;">+10</button>
                <button onclick="modStat('a','s',-10)" style="background:#444; border:none; color:#fff; cursor:pointer;">-10</button>
                <button onclick="modStat('a','h',1)" style="background:#444; border:none; color:#fff; cursor:pointer;">+â¤</button>
                <button onclick="modStat('a','h',-1)" style="background:#444; border:none; color:#fff; cursor:pointer;">-â¤</button>
            </div>
        </div>

        <!-- Center Stage -->
        <div class="card-stage">
            <div class="main-card" id="game-card" onclick="flipCard()">
                <div class="card-face front">
                    <div class="q-visual" id="card-img"></div>
                    <div class="q-body">
                        <div class="q-cat" id="q-cat">æº–å‚™</div>
                        <div class="q-text" id="q-text">é»æ“Šä¸‹æ–¹ã€ŒæŠ½å–è©¦ç…‰ã€<br>é–‹å§‹å°æ±º</div>
                        <div style="margin-top:auto; font-size:0.9rem; color:#999;">(é»æ“Šå¡ç‰‡ç¿»é–±ç­”æ¡ˆ)</div>
                    </div>
                </div>
                <div class="card-face back">
                    <div style="font-size:1.5rem; color:#c0392b; border-bottom:2px solid #ccc; margin-bottom:15px; font-weight:bold;">åƒè€ƒè©³è§£</div>
                    <div style="font-size:1.5rem; line-height:1.6; font-weight:500;" id="q-ans"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="team-panel team-b" id="panel-b">
            <div class="avatar-frame">
                <div class="avatar" style="background-image: url('https://images.unsplash.com/photo-1517849845537-4d257902454a?w=400')"></div>
            </div>
            <div class="team-title" style="color:#74b9ff;">å©‰ç´„æ´¾</div>
            <div class="score-display" id="score-b">100</div>
            <div class="hearts-container" id="hearts-b">â¤ï¸â¤ï¸â¤ï¸</div>
            <div class="student-plate">
                <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">å…ˆé‹’æˆ°å°‡</div>
                <div class="student-name" id="student-name-b">æº–å‚™</div>
            </div>
            <!-- Admin Controls -->
            <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:5px; width:100%; opacity:0.3; transition:0.3s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.3">
                <button onclick="modStat('b','s',10)" style="background:#444; border:none; color:#fff; cursor:pointer;">+10</button>
                <button onclick="modStat('b','s',-10)" style="background:#444; border:none; color:#fff; cursor:pointer;">-10</button>
                <button onclick="modStat('b','h',1)" style="background:#444; border:none; color:#fff; cursor:pointer;">+â¤</button>
                <button onclick="modStat('b','h',-1)" style="background:#444; border:none; color:#fff; cursor:pointer;">-â¤</button>
            </div>
        </div>
    </div>

    <footer>
        <div style="justify-self: start;">
            <button class="gem-btn btn-red" onclick="showWheel()">ğŸ’€ çµ‚æ¥µæ‡²ç½°</button>
        </div>
        <div style="justify-self: center; display:flex; gap:20px;">
            <button class="gem-btn btn-gold" id="btn-draw" onclick="drawQuestion()">ğŸ”® æŠ½å–è©¦ç…‰</button>
            <div id="action-btns" class="hidden" style="display:flex; gap:20px;">
                <button class="gem-btn btn-green" onclick="initSelection('chance')">â­• ç­”å° (è³)</button>
                <button class="gem-btn btn-red" onclick="initSelection('punish')">âŒ ç­”éŒ¯ (ç½°)</button>
            </div>
        </div>
        <div style="justify-self: end;"></div>
    </footer>
</div>

<!-- 3-Card Selection Overlay (The Tarot Cards) -->
<div class="overlay" id="overlay-select">
    <h1 id="select-title" style="font-family:var(--font-title); font-size:4rem; color:var(--gold-primary); text-shadow:0 0 20px #000; margin-bottom:50px;">å‘½é‹æŠ‰æ“‡</h1>
    <div class="cards-container" id="cards-grid">
        <!-- JS will inject cards here -->
    </div>
    <button class="gem-btn btn-gold hidden" id="btn-confirm-select" style="margin-top:60px; transform:scale(1.2);" onclick="closeSelection()">ç¢ºèªçµæœ</button>
</div>

<!-- Settings Overlay -->
<div class="overlay" id="overlay-settings">
    <div class="settings-modal">
        <h2 style="color:var(--gold-primary); margin-bottom:20px;">å¾Œå°ç®¡ç†</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
            <div>
                <h4>è±ªæ”¾æ´¾åå–®</h4>
                <textarea id="input-roster-a" placeholder="ä¸€è¡Œä¸€å€‹åå­—"></textarea>
            </div>
            <div>
                <h4>å©‰ç´„æ´¾åå–®</h4>
                <textarea id="input-roster-b" placeholder="ä¸€è¡Œä¸€å€‹åå­—"></textarea>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="gem-btn" style="flex:1; font-size:1rem;" onclick="saveRoster()">ğŸ’¾ å„²å­˜</button>
            <button class="gem-btn" style="flex:1; font-size:1rem;" onclick="exportExcel()">ğŸ“¥ å‚™ä»½æ•¸æ“š</button>
            <button class="gem-btn" style="flex:1; font-size:1rem; position:relative;">
                ğŸ“¤ ä¸Šå‚³æ•¸æ“š
                <input type="file" onchange="importExcel(this)" style="position:absolute; left:0; top:0; width:100%; height:100%; opacity:0; cursor:pointer;">
            </button>
            <button class="gem-btn btn-red" style="flex:1; font-size:1rem;" onclick="document.getElementById('overlay-settings').style.display='none'">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- Wheel Overlay -->
<div class="overlay" id="overlay-wheel">
    <h1 style="font-family:var(--font-title); color:var(--gold-primary); font-size:4rem; text-shadow:0 0 20px black;">çµ‚æ¥µè¼ªç›¤</h1>
    <div style="width:500px; height:500px; position:relative; margin:30px;">
        <div style="position:absolute; top:-30px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:25px solid transparent; border-right:25px solid transparent; border-top:50px solid #fff; z-index:10; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.5));"></div>
        <canvas id="wheel-canvas" width="500" height="500" style="width:100%; height:100%; border-radius:50%; border:10px solid var(--gold-primary); box-shadow:0 0 60px rgba(0,0,0,0.8); transition:transform 5s cubic-bezier(0.1,0,0.1,1);"></canvas>
    </div>
    <button class="gem-btn btn-gold" id="btn-spin" onclick="spinWheel()">ğŸš€ å•Ÿå‹•</button>
    <button class="gem-btn hidden" id="btn-close-wheel" style="margin-top:20px;" onclick="document.getElementById('overlay-wheel').style.display='none'">é—œé–‰</button>
</div>

<!-- Popup -->
<div class="overlay" id="overlay-popup">
    <div style="background:#fff; width:500px; padding:40px; border-radius:30px; text-align:center; border:6px solid var(--gold-primary); color:#000;">
        <div style="font-size:6rem;">âš ï¸</div>
        <h2 id="popup-title" style="color:#c0392b; font-size:3rem; margin:10px 0;">æ¨™é¡Œ</h2>
        <p id="popup-desc" style="font-size:1.8rem; font-weight:bold; margin:20px 0;">å…§å®¹</p>
        <button class="gem-btn btn-red" onclick="document.getElementById('overlay-popup').style.display='none'">é—œé–‰</button>
    </div>
</div>

<script>
    // --- FULL DATABASE ---
    let db = {
        questions: [
            { cat: "è˜‡è»¾ã€Šå¿µå¥´å¬Œã€‹", q: "ã€Œå¤§æ±Ÿæ±å»ï¼Œæµªæ·˜ç›¡ã€åƒå¤é¢¨æµäººç‰©ã€ä¸€å¥ï¼Œå¥ å®šäº†å…¨è©æ€æ¨£çš„æ„Ÿæƒ…åŸºèª¿ï¼Ÿ", a: "å¥ å®šäº†ã€æ‚²æ¶¼é›„å£¯ã€‘çš„åŸºèª¿ã€‚æ„Ÿæ…¨æ™‚å…‰æµé€ï¼Œæ­·å²ä¸Šçš„è‹±é›„äººç‰©éƒ½éš¨æ™‚é–“æ¶ˆé€ï¼Œå¼•å‡ºå¾Œæ–‡å°æ­·å²èˆˆè¡°çš„æ„Ÿå˜†ã€‚", img: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=600" },
            { cat: "è˜‡è»¾ã€Šå¿µå¥´å¬Œã€‹", q: "è©ä¸­ã€Œäº‚çŸ³ç©¿ç©ºï¼Œé©šæ¿¤æ‹å²¸ï¼Œæ²èµ·åƒå †é›ªã€é‹ç”¨äº†å“ªäº›ä¿®è¾­æ‰‹æ³•ï¼Ÿ", a: "1. ã€èª‡å¼µã€‘ï¼ˆç©¿ç©ºã€åƒå †é›ªï¼‰<br>2. ã€æ“¬äººã€‘ï¼ˆé©šæ¿¤æ‹å²¸ï¼‰<br>3. ã€å€Ÿå–»ã€‘ï¼ˆä»¥ã€Œé›ªã€å–»æµªèŠ±ï¼‰ã€‚", img: "https://images.unsplash.com/photo-1505673542670-a5e3ff5b14a3?w=600" }
        ],
        ops: [
            { title: "ç¾½æ‰‡ç¶¸å·¾", desc: "ã€è«‡ç¬‘é–“ã€‘æŒ‡å®šæ•µæ–¹ä¸€åã€Œä¸»å°‡ã€ç¦è¨€ä¸€å›åˆã€‚", val: 0 },
            { title: "å¤§æ±Ÿæ±å»", desc: "æ°£å‹¢å¦‚è™¹ï¼ç›´æ¥æ‰£é™¤æ•µæ–¹ 20 åˆ†ã€‚", val: 20 },
            { title: "æ±é¢¨å¤œæ”¾", desc: "èŠ±åƒæ¨¹ï¼Œæ˜Ÿå¦‚é›¨ã€‚æœ¬é¡Œå¾—åˆ†é›™å€ (åŠ  20 åˆ†)ã€‚", val: 20 },
            { title: "å¿ƒå‡å½¢é‡‹", desc: "èˆ‡è¬åŒ–å†¥åˆï¼ŒæŠµéŠ·ä¸‹ä¸€æ¬¡å—åˆ°çš„ä»»ä½•æ‡²ç½°ã€‚", val: 0 }
        ],
        puns: [
            { title: "æ—©ç”Ÿè¯é«®", desc: "å¤šæƒ…æ‡‰ç¬‘æˆ‘ã€‚å…¨éšŠè¢«å˜²ç¬‘ï¼Œæœ¬é¡Œå€’æ‰£ 10 åˆ†ã€‚", val: 10 },
            { title: "å€Ÿé…’æ¾†æ„", desc: "ä¸‰æ¯å…©ç›æ·¡é…’ã€‚é ­æ˜è…¦è„¹ï¼Œä¸‹å›åˆç­”é¡Œæ™‚é–“æ¸›åŠã€‚", val: 0 },
            { title: "ç‡ˆç«é—ŒçŠ", desc: "éšŠå‹å¤±è¹¤äº†ï¼Ÿä¸‹å›åˆéšŠé•·å¿…é ˆã€Œå­¤ç¨ä½œç­”ã€ã€‚", val: 0 },
            { title: "æ†”æ‚´æ", desc: "äººæ¯”é»ƒèŠ±ç˜¦ã€‚å…¨éšŠé«”åŠ›ä¸æ”¯ï¼Œä¸‹å›åˆå¿…é ˆå…¨é«”ã€Œè¶´åœ¨æ¡Œä¸Šã€ä½œç­”ã€‚", val: 0 }
        ],
        wheel: [ "çŸ‡çœ¼æ‘¸äºº (10ç§’)", "äººé«”æµ·æµª+é…éŸ³", "æ¨¡ä»¿æŸ³å®—å…ƒåå§¿", "å§¨æ¯ç¬‘å®šæ ¼30ç§’", "æ·±æƒ…æœ—èª¦", "äººé«”è½å­", "é€£ç’°å˜†æ°£", "Chokæ¨£å®šæ ¼", "å“­è…” Rap" ],
        roster: { a: ["æç™½", "æœç”«", "ç‹ç¶­"], b: ["è˜‡è»¾", "æ­é™½ä¿®", "ç‹å®‰çŸ³"] }
    };

    let state = { hearts: {a:3, b:3}, scores: {a:100, b:100}, turn: 'a', curQ: null };
    let wheelDeg = 0;

    // --- Core Logic ---
    function init() { 
        updateUI(); initWheel(); 
        document.getElementById('input-roster-a').value = db.roster.a.join('\n');
        document.getElementById('input-roster-b').value = db.roster.b.join('\n');
    }

    function updateUI() {
        document.getElementById('q-count').innerText = db.questions.length;
        const t = state.turn;
        const a = document.getElementById('panel-a'), b = document.getElementById('panel-b');
        
        if (t === 'a') { a.classList.add('active'); b.classList.remove('active'); }
        else { b.classList.add('active'); a.classList.remove('active'); }
        
        ['a','b'].forEach(team => {
            document.getElementById(`score-${team}`).innerText = state.scores[team];
            let h = "";
            for(let i=0; i<state.hearts[team]; i++) h += "â¤ï¸";
            if(state.hearts[team]<=0) h = "ğŸ’”";
            document.getElementById(`hearts-${team}`).innerText = h;
        });
    }

    function modStat(team, type, val) {
        if (type === 'h') state.hearts[team] = Math.max(0, state.hearts[team] + val);
        else state.scores[team] += val;
        updateUI();
    }

    function drawQuestion() {
        if (db.questions.length === 0) return alert("é¡Œåº«å·²ç©ºï¼");
        const idx = Math.floor(Math.random() * db.questions.length);
        state.curQ = db.questions[idx];
        db.questions.splice(idx, 1);

        const r = db.roster[state.turn];
        const s = (r && r.length) ? r[Math.floor(Math.random() * r.length)] : "å…¨é«”éšŠå“¡";
        document.getElementById(`student-name-${state.turn}`).innerText = s;
        document.getElementById(`student-name-${state.turn==='a'?'b':'a'}`).innerText = "---";

        document.getElementById('game-card').classList.remove('flipped');
        document.getElementById('q-cat').innerText = state.curQ.cat;
        document.getElementById('q-text').innerText = state.curQ.q;
        document.getElementById('q-ans').innerHTML = state.curQ.a;
        
        const img = document.getElementById('card-img');
        if(state.curQ.img && state.curQ.img.startsWith('http')) {
            img.style.backgroundImage = `url('${state.curQ.img}')`;
        } else {
            img.style.backgroundImage = `none`;
        }

        document.getElementById('btn-draw').classList.add('hidden');
        document.getElementById('action-btns').classList.remove('hidden');
        updateUI();
    }

    function flipCard() { document.getElementById('game-card').classList.toggle('flipped'); }

    // --- High-End Card Selection ---
    function initSelection(type) {
        const t = state.turn;
        if(type === 'chance') { modStat(t,'s',10); modStat(t,'h',1); }
        else { modStat(t,'s',-10); modStat(t,'h',-1); }

        const pool = type === 'chance' ? db.ops : db.puns;
        const shuffled = [...pool].sort(() => 0.5 - Math.random());
        const selected3 = shuffled.slice(0, 3);
        while(selected3.length < 3) selected3.push({title:"ç©ºç¼º", desc:"...", val:0});

        const grid = document.getElementById('cards-grid');
        grid.innerHTML = '';
        
        const overlayClass = type === 'chance' ? 'style-chance' : 'style-punish';
        document.getElementById('overlay-select').className = `overlay ${overlayClass}`;
        
        document.getElementById('select-title').innerText = type === 'chance' ? "âœ¨ å‘½é‹æ©è³œ âœ¨" : "âš¡ å„é‹é™è‡¨ âš¡";
        document.getElementById('select-title').style.color = type === 'chance' ? "#d4af37" : "#c0392b";

        selected3.forEach(item => {
            const card = document.createElement('div');
            card.className = 'tarot-card';
            card.onclick = () => pickCard(card, item, type);
            // é«˜ç´šå¡é¢çµæ§‹
            card.innerHTML = `
                <div class="tarot-face tarot-back">
                    <div class="tarot-emblem">${type==='chance'?'âšœï¸':'ğŸ’€'}</div>
                </div>
                <div class="tarot-face tarot-front">
                    <div class="tf-type">${type==='chance'?'Chance Card':'Punishment'}</div>
                    <div class="tf-title">${item.title}</div>
                    <div class="tf-desc">${item.desc}</div>
                    ${item.val !== 0 ? `<div class="tf-val">${item.val > 0 ? '+' : ''}${item.val} åˆ†</div>` : ''}
                </div>
            `;
            grid.appendChild(card);
        });

        document.getElementById('btn-confirm-select').classList.add('hidden');
        document.getElementById('overlay-select').style.display = 'flex';
    }

    function pickCard(cardEl, item, type) {
        if(cardEl.classList.contains('flipped') || document.querySelector('.tarot-card.flipped')) return;
        cardEl.classList.add('flipped');
        
        document.querySelectorAll('.tarot-card').forEach(c => {
            if(c !== cardEl) c.classList.add('disabled');
        });

        const cur = state.turn;
        const opp = cur === 'a' ? 'b' : 'a';

        if(item.val !== 0) {
            if(item.desc.includes("æ‰£é™¤æ•µæ–¹") || item.desc.includes("æ‰£")) {
                if(type === 'chance' && item.desc.includes("æ•µ")) modStat(opp, 's', -item.val);
                else modStat(cur, 's', -item.val);
            } else {
                modStat(cur, 's', type==='chance' ? item.val : -item.val);
            }
        }

        setTimeout(() => { document.getElementById('btn-confirm-select').classList.remove('hidden'); }, 600);
    }

    function closeSelection() {
        document.getElementById('overlay-select').style.display = 'none';
        state.turn = state.turn === 'a' ? 'b' : 'a';
        document.getElementById('btn-draw').classList.remove('hidden');
        document.getElementById('action-btns').classList.add('hidden');
        document.getElementById('game-card').classList.remove('flipped');
        updateUI();
    }

    // --- Wheel Logic ---
    function showWheel() { 
        document.getElementById('overlay-wheel').style.display='flex'; 
        initWheel(); 
        document.getElementById('btn-spin').disabled = false;
        document.getElementById('btn-close-wheel').classList.add('hidden');
    }
    
    function initWheel() {
        const cvs = document.getElementById('wheel-canvas');
        const ctx = cvs.getContext('2d');
        const w=500, h=500, cx=250, cy=250, r=240;
        const len = db.wheel.length;
        const arc = Math.PI*2/len;
        const colors = ['#1a1a1a', '#222'];

        ctx.clearRect(0,0,w,h);
        for(let i=0; i<len; i++) {
            const ang = i*arc;
            ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,ang,ang+arc);
            ctx.fillStyle = colors[i%2]; ctx.fill(); 
            ctx.lineWidth = 2; ctx.strokeStyle = "#d4af37"; ctx.stroke();
            
            ctx.save(); ctx.translate(cx,cy); ctx.rotate(ang + arc/2);
            ctx.textAlign="right"; ctx.fillStyle="#d4af37"; ctx.font="bold 20px sans-serif";
            let t = db.wheel[i];
            let m = t.match(/ã€(.*?)ã€‘/);
            t = m ? m[1] : (t.length>8 ? t.substring(0,8)+"..." : t);
            ctx.fillText(t, r-30, 6); ctx.restore();
        }
    }

    function spinWheel() {
        const canvas = document.getElementById('wheel-canvas');
        document.getElementById('btn-spin').disabled=true;
        const len = db.wheel.length;
        const idx = Math.floor(Math.random() * len);
        const deg = 360/len;
        const target = 360*5 + (270 - (idx*deg + deg/2));
        wheelDeg += target;
        canvas.style.transform = `rotate(${wheelDeg}deg)`;
        
        setTimeout(() => {
            document.getElementById('btn-close-wheel').classList.remove('hidden');
            const txt = db.wheel[idx];
            const m = txt.match(/ã€(.*?)ã€‘(.*)/);
            document.getElementById('popup-title').innerText = m ? m[1] : "æ‡²ç½°";
            document.getElementById('popup-desc').innerText = m ? m[2] : txt;
            document.getElementById('overlay-popup').style.display='flex';
        }, 5000);
    }

    // --- Settings & Excel ---
    function openSettings() { document.getElementById('overlay-settings').style.display='flex'; }
    function saveRoster() {
        db.roster.a = document.getElementById('input-roster-a').value.split('\n').map(s=>s.trim()).filter(s=>s);
        db.roster.b = document.getElementById('input-roster-b').value.split('\n').map(s=>s.trim()).filter(s=>s);
        alert("åå–®å·²å„²å­˜ï¼");
    }

    function exportExcel() {
        const wb = XLSX.utils.book_new();
        const qData = db.questions.map(i=>({åˆ†é¡:i.cat, é¡Œç›®:i.q, ç­”æ¡ˆ:i.a, åœ–ç‰‡:i.img}));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(qData), "é¡Œç›®");
        const oData = db.ops.map(i=>({æ¨™é¡Œ:i.title, æè¿°:i.desc, æ•¸å€¼:i.val}));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(oData), "æ©Ÿæœƒ");
        const pData = db.puns.map(i=>({æ¨™é¡Œ:i.title, æè¿°:i.desc, æ•¸å€¼:i.val}));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(pData), "æ‡²ç½°");
        const wData = db.wheel.map(i=>({å…§å®¹:i}));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(wData), "è¼ªç›¤");
        const rData = [];
        const max = Math.max(db.roster.a.length, db.roster.b.length);
        for(let i=0; i<max; i++) rData.push({TeamA: db.roster.a[i] || "", TeamB: db.roster.b[i] || ""});
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rData), "åå–®");
        XLSX.writeFile(wb, "å¤éŸ»å°æ±º_å®Œæ•´è³‡æ–™åº«.xlsx");
    }

    function importExcel(inp) {
        const f = inp.files[0]; if(!f)return;
        const r = new FileReader();
        r.onload = e => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type:'array'});
            if(wb.Sheets["é¡Œç›®"]) db.questions = XLSX.utils.sheet_to_json(wb.Sheets["é¡Œç›®"]).map(r=>({cat:r.åˆ†é¡, q:r.é¡Œç›®, a:r.ç­”æ¡ˆ, img:r.åœ–ç‰‡}));
            if(wb.Sheets["æ©Ÿæœƒ"]) db.ops = XLSX.utils.sheet_to_json(wb.Sheets["æ©Ÿæœƒ"]).map(r=>({title:r.æ¨™é¡Œ, desc:r.æè¿°, val:parseInt(r.æ•¸å€¼)||0}));
            if(wb.Sheets["æ‡²ç½°"]) db.puns = XLSX.utils.sheet_to_json(wb.Sheets["æ‡²ç½°"]).map(r=>({title:r.æ¨™é¡Œ, desc:r.æè¿°, val:parseInt(r.æ•¸å€¼)||0}));
            if(wb.Sheets["è¼ªç›¤"]) db.wheel = XLSX.utils.sheet_to_json(wb.Sheets["è¼ªç›¤"]).map(r=>r.å…§å®¹||r.æ‡²ç½°å…§å®¹||Object.values(r)[0]);
            if(wb.Sheets["åå–®"]) {
                const raw = XLSX.utils.sheet_to_json(wb.Sheets["åå–®"]);
                db.roster.a = []; db.roster.b = [];
                raw.forEach(row => { if(row.TeamA) db.roster.a.push(row.TeamA); if(row.TeamB) db.roster.b.push(row.TeamB); });
                document.getElementById('input-roster-a').value = db.roster.a.join('\n');
                document.getElementById('input-roster-b').value = db.roster.b.join('\n');
            }
            alert("åŒ¯å…¥æˆåŠŸï¼"); updateUI();
        };
        r.readAsArrayBuffer(f);
    }

    window.onload = init;
</script>
</body>
</html>
